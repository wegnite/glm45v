# 代码注释规范修正计划

## 📋 问题说明
发现 `src/middleware.ts` 文件使用了英文注释，不符合项目中文注释规范。

## 🔍 需要修正的文件

### 高优先级（核心功能）
- [ ] `src/middleware.ts` - 用户归因系统中间件
  - 当前状态：英文注释
  - 修正方案：保留技术术语，其他说明改为中文

### 中优先级（可能需要检查）
- [ ] `src/services/config.ts` - 部分英文注释
- [ ] `src/auth/config.ts` - 混合注释

## 🎯 修正原则

### 1. 保留英文的情况
- 技术术语（如 UTM、Cookie、referrer）
- 标准概念（如 first-touch attribution、last-touch attribution）
- API 参数名和返回值说明

### 2. 改为中文的情况
- 功能说明
- 实现逻辑描述
- 使用场景说明
- 注意事项

### 3. 示例对比

**修正前（纯英文）**：
```typescript
/**
 * Parse UTM parameters from URL
 */
```

**修正后（中英混合）**：
```typescript
/**
 * 解析 URL 中的 UTM 参数
 * UTM (Urchin Tracking Module) 用于追踪营销活动效果
 */
```

## 📝 middleware.ts 注释修正对照表

| 原英文注释 | 建议中文注释 |
|-----------|------------|
| Next.js Enhanced Middleware Configuration | Next.js 增强中间件配置 |
| Internationalization (i18n) routing | 国际化（i18n）路由 |
| User attribution tracking | 用户归因追踪 |
| Cookie-based visitor identification | 基于 Cookie 的访客识别 |
| How it works | 工作原理 |
| Combines next-intl middleware with custom attribution tracking | 结合 next-intl 中间件与自定义归因追踪 |
| Tracks user source, device, and journey through the site | 追踪用户来源、设备和站内访问路径 |
| Maintains both first-touch and last-touch attribution | 同时维护首次触达和最后触达归因 |
| Parse UTM parameters from URL | 解析 URL 中的 UTM 参数 |
| Parse referrer to identify source | 解析 referrer 识别来源 |
| Generate unique IDs | 生成唯一标识符 |
| Attribution tracking middleware | 归因追踪中间件 |
| Skip attribution for API routes and static files | 跳过 API 路由和静态文件的归因处理 |
| Get existing attribution cookie | 获取现有的归因 Cookie |
| Parse current visit data | 解析当前访问数据 |
| Initialize or update attribution | 初始化或更新归因信息 |
| First visit - create new attribution | 首次访问 - 创建新的归因记录 |
| Returning visitor - update last-touch attribution | 回访用户 - 更新最后触达归因 |
| Update session if more than 30 minutes since last visit | 如果距离上次访问超过30分钟，更新会话 |
| Set the attribution cookie | 设置归因 Cookie |
| Add visitor ID to response headers for client-side access | 添加访客 ID 到响应头供客户端访问 |
| Main middleware function | 主中间件函数 |
| Combines i18n and attribution tracking | 结合 i18n 和归因追踪 |
| Merge cookies from both responses | 合并两个响应的 Cookie |
| Middleware configuration | 中间件配置 |
| Defines which paths should be processed | 定义哪些路径需要处理 |

## 🚀 执行计划

### 第一阶段：核心文件修正
1. 修正 `middleware.ts` 的所有注释
2. 保留技术术语的英文原文
3. 添加必要的中文解释

### 第二阶段：全项目检查
1. 使用脚本扫描所有 `.ts` 和 `.tsx` 文件
2. 识别英文注释
3. 批量修正或标记需要人工处理的部分

### 第三阶段：规范落实
1. 更新 CLAUDE.md，明确注释语言规范
2. 添加 pre-commit hook 检查注释语言
3. 创建注释模板

## 📌 注意事项

1. **不要过度翻译**：技术术语保持英文更清晰
2. **保持一致性**：同一概念在整个项目中使用相同的翻译
3. **考虑可读性**：中英混合时注意排版和空格
4. **版本控制**：修正注释时创建独立的 commit

---

*创建时间：2025-08-17*
*状态：待执行*