# AI Universal Generator - Complete Project Guide

## 🎯 Executive Summary

The AI Universal Generator is a production-ready, full-stack Next.js application that provides a unified platform for AI content generation. Built on the ShipAny template foundation, it integrates multiple AI providers for text, image, and video generation with enterprise features including authentication, payment processing, and internationalization.

### Key Metrics
- **Version**: 2.6.0
- **Framework**: Next.js 15.2 with App Router
- **Database**: PostgreSQL (Supabase) with Drizzle ORM
- **Authentication**: NextAuth 5.0 beta with OAuth providers
- **Payment**: Dual integration (Creem + Stripe)
- **Languages**: English & Chinese (i18n)
- **AI Providers**: 6+ integrated providers

## 📊 System Architecture

### High-Level Architecture
```
┌─────────────────────────────────────────────────────────────┐
│                        Frontend Layer                        │
│  Next.js App Router │ React 19 │ TypeScript │ Tailwind CSS  │
├─────────────────────────────────────────────────────────────┤
│                      Application Layer                       │
│   API Routes │ Server Components │ Server Actions │ i18n     │
├─────────────────────────────────────────────────────────────┤
│                       Services Layer                         │
│  AI SDK │ Auth Service │ Credit System │ Payment Processing │
├─────────────────────────────────────────────────────────────┤
│                        Data Layer                           │
│     Drizzle ORM │ Supabase PostgreSQL │ Cloudflare R2      │
└─────────────────────────────────────────────────────────────┘
```

### Request Flow
```
User Request → Next.js Middleware → Route Handler → Service Layer → AI Provider
                                          ↓
                                    Database/Cache
                                          ↓
                                    Response → Client
```

## 🔑 Core Features Analysis

### 1. AI Generation System

#### Supported Providers & Models

**Text Generation:**
- **OpenAI**: GPT-4o, GPT-4o-mini, GPT-3.5-turbo
- **DeepSeek**: deepseek-chat, deepseek-r1 (with reasoning)
- **OpenRouter**: 100+ models including Llama, Claude, Mistral
- **SiliconFlow**: DeepSeek-R1, Qwen models

**Image Generation:**
- **DALL-E**: Version 2 & 3
- **Midjourney**: V5.2, V6 (via proxy)
- **FLUX**: Schnell, Pro models
- **Replicate**: Stable Diffusion XL, custom models

**Video Generation:**
- **Kling**: V1.0, V1.5 models
- **Runway**: Gen-2, Gen-3
- **Pika**: 1.0

#### Generation Pipeline
```typescript
// Simplified generation flow
1. User Input → Validation
2. Credit Check → Deduction
3. Provider Selection → Model Configuration
4. API Request → Response Processing
5. Result Storage → User Display
```

### 2. Authentication & Authorization

#### Auth Flow
```
1. User clicks sign-in
2. Redirect to OAuth provider (Google/GitHub)
3. Callback with user data
4. Create/update user record
5. Generate JWT session
6. Set secure HTTP-only cookies
```

#### Session Management
- **Provider**: NextAuth v5 (beta)
- **Storage**: JWT with secure cookies
- **Expiry**: 30 days (configurable)
- **Refresh**: Automatic on activity

### 3. Credit & Payment System

#### Credit Flow
```
User Registration → Initial Credits (configurable)
        ↓
   Use Service → Credit Deduction
        ↓
   Low Balance → Payment Required
        ↓
   Checkout → Stripe/Creem
        ↓
   Success → Credit Addition
```

#### Pricing Model
- **Text Generation**: 1 credit per request
- **Image Generation**: 5 credits per image
- **Video Generation**: 20 credits per video
- **Subscription Tiers**: Basic, Pro, Enterprise

### 4. Database Schema

#### Core Tables Structure
```sql
-- Users (Primary entity)
users: id, uuid, email, nickname, avatar_url, locale, invite_code

-- Authentication
accounts: OAuth provider linkage
sessions: Active user sessions

-- Business Logic
orders: Payment transactions
credits: Credit transactions
apikeys: API key management

-- Content
posts: Blog/documentation content
feedbacks: User feedback collection

-- Affiliate System
affiliates: Referral tracking
```

## 🛠️ Development Environment Setup

### Prerequisites
```bash
# Required
Node.js 20.x+
npm/pnpm package manager
PostgreSQL database
Git

# Optional
Docker for containerization
Vercel CLI for deployment
```

### Environment Configuration

Create `.env.local` with:
```env
# Database
DATABASE_URL=postgresql://...

# NextAuth
AUTH_SECRET=<generate-with-openssl>
NEXTAUTH_URL=http://localhost:3000

# OAuth Providers
AUTH_GOOGLE_ID=
AUTH_GOOGLE_SECRET=
AUTH_GITHUB_ID=
AUTH_GITHUB_SECRET=

# AI Providers
OPENAI_API_KEY=
DEEPSEEK_API_KEY=
OPENROUTER_API_KEY=
SILICONFLOW_API_KEY=
REPLICATE_API_TOKEN=
KLING_ACCESS_KEY=
KLING_SECRET_KEY=

# Payment
STRIPE_PUBLIC_KEY=
STRIPE_SECRET_KEY=
CREEM_API_KEY=

# Storage
R2_ACCOUNT_ID=
R2_ACCESS_KEY_ID=
R2_SECRET_ACCESS_KEY=
```

### Installation Steps
```bash
# 1. Clone repository
git clone <repository-url>
cd ai-shipany-v2.6.0-ai_model

# 2. Install dependencies
pnpm install

# 3. Setup database
pnpm db:generate
pnpm db:migrate

# 4. Run development server
pnpm dev

# 5. Access application
open http://localhost:3000
```

## 📁 Project Structure Deep Dive

### Critical Directories

#### `/src/app` - Next.js App Router
- **`[locale]`**: Internationalized routes
- **`api`**: RESTful API endpoints
- **`(default)`**: Public pages
- **`(console)`**: Authenticated user dashboard
- **`(admin)`**: Admin panel

#### `/src/aisdk` - AI Integration Layer
Custom SDK implementations for each provider with standardized interfaces:
- Error handling & retry logic
- Rate limiting
- Response normalization
- Streaming support

#### `/src/components/blocks/ai-generator`
Core UI component for AI generation:
- Provider selection
- Model configuration
- Input handling
- Result display with markdown support
- Credit tracking

#### `/src/services` - Business Logic
- **`credit.ts`**: Credit management
- **`user.ts`**: User operations
- **`order.ts`**: Payment processing
- **`affiliate.ts`**: Referral system

## 🚀 API Endpoints Reference

### Public APIs
```typescript
POST /api/demo/gen-text
// Generate text content
{
  prompt: string,
  provider: "openai" | "deepseek" | "openrouter" | "siliconflow",
  model: string
}

POST /api/demo/gen-image
// Generate images
{
  prompt: string,
  provider: string,
  model: string,
  size?: string,
  n?: number
}

GET /api/demo/gen-stream-text
// Server-sent events for streaming
```

### Protected APIs (Requires Authentication)
```typescript
GET /api/get-user-info
// Returns user profile and settings

GET /api/get-user-credits
// Returns credit balance and history

POST /api/checkout
// Create payment session
{
  productId: string,
  quantity: number
}
```

### Webhook Endpoints
```typescript
POST /api/pay/notify/stripe
// Stripe payment webhooks

POST /api/pay/notify/creem
// Creem payment webhooks
```

## 🎨 UI/UX Components

### Design System
- **Base**: Radix UI primitives
- **Styling**: Tailwind CSS v4
- **Animations**: Framer Motion
- **Icons**: Lucide React + Tabler Icons
- **Theme**: Light/Dark mode with system preference

### Component Library Structure
```
/components
├── ui/           # Base components (Button, Card, Input)
├── blocks/       # Feature components (AIGenerator, Pricing)
├── layouts/      # Page layouts (Dashboard, Console)
└── forms/        # Form components with validation
```

### Key UI Features
1. **Responsive Design**: Mobile-first approach
2. **Accessibility**: WCAG 2.1 AA compliance
3. **Performance**: Lazy loading, code splitting
4. **Internationalization**: RTL support ready

## 🔒 Security Implementation

### Security Measures
1. **Input Validation**: Zod schemas for all inputs
2. **SQL Injection Prevention**: Parameterized queries via Drizzle
3. **XSS Protection**: React's automatic escaping + CSP headers
4. **CSRF Protection**: SameSite cookies + token validation
5. **Rate Limiting**: API route middleware
6. **Secrets Management**: Environment variables + Vercel secrets

### Authentication Security
- OAuth 2.0 flow with PKCE
- Secure session cookies (httpOnly, secure, sameSite)
- JWT with short expiration
- Automatic token refresh

## 📈 Performance Optimization

### Current Performance Metrics
- **First Contentful Paint**: < 1.5s
- **Time to Interactive**: < 3s
- **Lighthouse Score**: 85-95
- **Bundle Size**: ~450KB initial

### Optimization Techniques
1. **Server Components**: Reduced client JavaScript
2. **Dynamic Imports**: Code splitting for features
3. **Image Optimization**: Next.js Image with CDN
4. **Caching Strategy**: 
   - Static pages: ISR with 24h revalidation
   - API responses: Redis caching (planned)
   - Assets: CloudFlare CDN

## 🧪 Testing Strategy

### Test Coverage
```bash
/test
├── integration/        # API and feature tests
│   ├── ai-generation.test.js
│   ├── auth-flow.test.js
│   └── payment.test.js
├── unit/              # Component and utility tests
└── e2e/               # End-to-end scenarios
```

### Testing Commands
```bash
# Run all tests
pnpm test

# Integration tests only
pnpm test:integration

# With coverage
pnpm test:coverage
```

## 🌍 Internationalization (i18n)

### Supported Languages
- **English** (en): Default
- **Chinese** (zh): Complete translation

### Translation Structure
```
/src/i18n
├── messages/          # Global translations
│   ├── en.json
│   └── zh.json
└── pages/            # Page-specific content
    ├── landing/
    ├── pricing/
    └── showcase/
```

### Adding New Language
1. Create message files in `/src/i18n/messages/[locale].json`
2. Add locale to `routing.ts`
3. Translate page content in `/src/i18n/pages/`
4. Update locale selector component

## 📦 Deployment Guide

### Vercel Deployment (Recommended)
```bash
# 1. Install Vercel CLI
npm i -g vercel

# 2. Login
vercel login

# 3. Deploy
vercel --prod

# 4. Set environment variables in Vercel dashboard
```

### Docker Deployment
```bash
# Build image
docker build -t ai-generator .

# Run container
docker run -p 3000:3000 \
  --env-file .env.production \
  ai-generator
```

### Self-Hosted Requirements
- Node.js 20+
- PostgreSQL 14+
- Redis (optional, for caching)
- 2GB RAM minimum
- SSL certificate

## 🔧 Troubleshooting Guide

### Common Issues & Solutions

#### 1. API Key Issues
```bash
Error: "OpenAI API quota exceeded"
Solution: Switch to OpenRouter or add credits to OpenAI account
```

#### 2. Database Connection
```bash
Error: "Cannot connect to database"
Solution: Check DATABASE_URL and network connectivity
```

#### 3. Build Failures
```bash
Error: "Build optimization failed"
Solution: Clear .next folder and node_modules, reinstall
```

#### 4. Authentication Problems
```bash
Error: "OAuth callback error"
Solution: Verify redirect URLs in provider console
```

## 📊 Monitoring & Analytics

### Integrated Analytics
1. **Vercel Analytics**: Performance metrics
2. **Google Analytics**: User behavior
3. **OpenPanel**: Custom events
4. **Plausible**: Privacy-focused analytics

### Key Metrics to Track
- User registration rate
- Credit consumption patterns
- API usage by provider
- Generation success/failure rates
- Payment conversion rates

## 🚀 Future Roadmap

### Planned Features
1. **Q1 2025**
   - Websocket support for real-time generation
   - Advanced prompt templates
   - Batch processing API

2. **Q2 2025**
   - Mobile app (React Native)
   - Plugin system for custom providers
   - Advanced analytics dashboard

3. **Q3 2025**
   - Multi-tenant SaaS mode
   - White-label solutions
   - API marketplace

## 📚 Additional Resources

### Documentation
- [Next.js Documentation](https://nextjs.org/docs)
- [Drizzle ORM Guide](https://orm.drizzle.team)
- [NextAuth.js Guide](https://authjs.dev)
- [Tailwind CSS Reference](https://tailwindcss.com)

### Community
- GitHub Issues: Bug reports and feature requests
- Discord: Community support
- Documentation site: Detailed guides

## 🤝 Contributing Guidelines

### Development Workflow
1. Fork repository
2. Create feature branch
3. Implement changes with tests
4. Ensure linting passes
5. Submit pull request

### Code Standards
- TypeScript for type safety
- ESLint for code quality
- Prettier for formatting
- Conventional commits

---

**Document Version**: 2.0.0  
**Last Updated**: 2025-08-15  
**Maintained By**: AI Universal Generator Team

## Quick Reference Card

### Essential Commands
```bash
# Development
pnpm dev                # Start dev server
pnpm build             # Build production
pnpm lint              # Run linting
pnpm type-check        # TypeScript check

# Database
pnpm db:generate       # Generate migration
pnpm db:migrate        # Run migrations
pnpm db:studio         # Open Drizzle Studio
pnpm db:push          # Push schema changes

# Testing
pnpm test             # Run all tests
pnpm test:integration # Integration tests only

# Deployment
pnpm docker:build     # Build Docker image
vercel --prod         # Deploy to Vercel
```

### Environment Variables Checklist
- [ ] Database connection string
- [ ] NextAuth secret and URL
- [ ] OAuth provider credentials
- [ ] AI provider API keys
- [ ] Payment gateway keys
- [ ] Storage credentials
- [ ] Analytics IDs

### Health Check Endpoints
- `/api/ping` - Basic health check
- `/` - Frontend availability
- `/api/auth/session` - Auth system status