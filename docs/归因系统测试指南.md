# 归因系统测试指南

## 🎯 问题诊断

您提到访问页面后没有看到数据库记录，这是因为：

1. **Cookie染色** - 访问页面时只设置Cookie（已实现✅）
2. **访问日志** - 需要调用追踪API才会记录到`visitor_logs`表（现已添加✅）
3. **用户归因** - 只有在用户注册时才会保存到`users`表
4. **订单归因** - 只有在创建订单时才会保存到`orders`表

## 🚀 完整测试流程

### 步骤1：启动开发服务器

```bash
npm run dev
```

### 步骤2：测试访问日志记录

1. **访问带UTM参数的URL：**
   ```
   http://localhost:3000/zh?utm_source=google&utm_medium=cpc&utm_campaign=test2025
   ```

2. **打开浏览器控制台（F12）**
   - 查看Network标签
   - 找到对 `/api/attribution/track` 的POST请求
   - 检查响应是否包含 `visitor_id` 和 `session_id`

3. **验证Cookie设置：**
   - 在控制台输入：
   ```javascript
   document.cookie.split(';').find(c => c.includes('user_attribution'))
   ```
   - 应该看到包含归因数据的Cookie

4. **检查数据库记录：**
   ```bash
   node test/verify-attribution.js
   ```

   或直接在Supabase SQL编辑器中查询：
   ```sql
   -- 查看最近的访问日志
   SELECT * FROM visitor_logs 
   ORDER BY visited_at DESC 
   LIMIT 10;
   ```

### 步骤3：测试用户注册归因

1. **先访问带归因的URL：**
   ```
   http://localhost:3000/zh?utm_source=facebook&utm_medium=social
   ```

2. **注册新用户：**
   - 点击登录/注册
   - 使用Google或GitHub登录
   - 完成注册流程

3. **验证用户归因数据：**
   ```sql
   -- 查看最新注册用户的归因
   SELECT 
     email,
     attribution_source,
     attribution_medium,
     attribution_campaign,
     first_device_type,
     first_country,
     created_at
   FROM users 
   WHERE attribution_source IS NOT NULL
   ORDER BY created_at DESC 
   LIMIT 1;
   ```

### 步骤4：测试订单归因

1. **登录状态下访问：**
   ```
   http://localhost:3000/zh/pricing?utm_source=email&utm_medium=newsletter
   ```

2. **创建订单：**
   - 选择一个价格方案
   - 点击订阅/购买
   - 完成支付流程（可以取消）

3. **验证订单归因：**
   ```sql
   -- 查看最新订单的归因
   SELECT 
     order_no,
     order_source,
     order_medium,
     order_device_type,
     created_at
   FROM orders 
   WHERE order_source IS NOT NULL
   ORDER BY created_at DESC 
   LIMIT 1;
   ```

## 🔍 实时监控

### 监控访问日志
```sql
-- 实时查看访问流
SELECT 
  visitor_id,
  utm_source,
  utm_medium,
  device_type,
  page_url,
  visited_at
FROM visitor_logs 
ORDER BY visited_at DESC 
LIMIT 20;
```

### 查看归因统计
```sql
-- 来源分布
SELECT 
  utm_source,
  COUNT(*) as visits,
  COUNT(DISTINCT visitor_id) as unique_visitors
FROM visitor_logs 
WHERE utm_source IS NOT NULL
GROUP BY utm_source
ORDER BY visits DESC;
```

### 设备类型分析
```sql
-- 设备分布
SELECT 
  device_type,
  COUNT(*) as count,
  ROUND(COUNT(*)::numeric / SUM(COUNT(*)) OVER() * 100, 2) as percentage
FROM visitor_logs 
WHERE device_type IS NOT NULL
GROUP BY device_type
ORDER BY count DESC;
```

## 🐛 常见问题

### 1. visitor_logs表没有数据

**原因：** 追踪组件未正确加载

**解决：**
- 确保 `AttributionTracker` 组件已添加到布局中
- 检查浏览器控制台是否有错误
- 查看Network标签是否有 `/api/attribution/track` 请求

### 2. Cookie设置了但数据库没有记录

**原因：** 归因数据分阶段保存

**解释：**
- 访问时：只设置Cookie和记录到visitor_logs
- 注册时：保存到users表
- 下单时：保存到orders表

### 3. API调用失败

**检查：**
```javascript
// 在浏览器控制台测试API
fetch('/api/attribution/track', {
  method: 'GET'
}).then(r => r.json()).then(console.log)
```

### 4. 位置信息为空

**原因：** IP地理API限制或本地开发

**解决：**
- 本地开发会显示 "Local/Localhost"
- 生产环境会正确显示地理位置

## 📈 数据分析API

### 获取当前访客信息
```javascript
// 浏览器控制台
fetch('/api/attribution/track', {
  method: 'GET'
})
.then(r => r.json())
.then(data => {
  console.log('访客ID:', data.visitor.id);
  console.log('首次来源:', data.first_touch);
  console.log('最后来源:', data.last_touch);
});
```

### 查看分析数据
需要登录后访问：
- `/api/attribution/analytics?type=overview` - 概览
- `/api/attribution/analytics?type=channels` - 渠道分析
- `/api/attribution/analytics?type=devices` - 设备分析

## ✅ 验证清单

- [ ] 访问页面后 `visitor_logs` 表有新记录
- [ ] Cookie `user_attribution` 已设置
- [ ] 浏览器控制台显示 "归因追踪成功"
- [ ] 新用户注册后 `users` 表有归因数据
- [ ] 创建订单后 `orders` 表有归因数据
- [ ] `/api/attribution/track` GET请求返回访客信息

## 🎉 成功标志

当您看到以下情况时，说明归因系统工作正常：

1. **visitor_logs表持续增长** - 每次页面访问都有记录
2. **用户归因准确** - 新注册用户包含完整归因信息
3. **订单归因完整** - 订单记录包含设备和来源信息
4. **Cookie正确设置** - 30天有效期，包含访客ID

---

如果仍有问题，请检查：
1. 浏览器控制台错误信息
2. Network标签中的API调用
3. 数据库连接是否正常
4. 表结构是否正确（运行迁移）