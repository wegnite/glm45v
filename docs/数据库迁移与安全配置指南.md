# 数据库迁移与安全配置指南

## 📚 目录
1. [数据库迁移流程](#数据库迁移流程)
2. [Supabase 安全配置](#supabase-安全配置)
3. [常见问题与解决方案](#常见问题与解决方案)
4. [最佳实践](#最佳实践)

---

## 数据库迁移流程

### 问题发现
在实施订阅系统时，发现虽然已配置 `DATABASE_URL`，但新创建的订阅表还没有同步到 Supabase 数据库。

### 解决步骤

#### 1. 添加表结构到主 Schema
```typescript
// src/db/schema.ts
export const subscriptions = pgTable("subscriptions", {
  id: integer().primaryKey().generatedAlwaysAsIdentity(),
  user_uuid: varchar({ length: 255 }).notNull().unique(),
  // ... 其他字段
});
```

#### 2. 生成迁移文件
```bash
npm run db:generate
```
这会在 `src/db/migrations/` 目录下生成新的 SQL 迁移文件。

#### 3. 执行迁移
```bash
npm run db:migrate
```
将迁移应用到 Supabase 数据库。

#### 4. 验证表创建
```javascript
// test/check-tables.js
const tables = ['subscriptions', 'subscription_plans', 'subscription_usage'];
// 验证每个表是否存在
```

### 关键发现
- **Drizzle ORM 迁移系统**：自动跟踪已应用的迁移，避免重复执行
- **迁移文件命名**：自动生成唯一的迁移文件名（如 `0001_crazy_princess_powerful.sql`）
- **环境变量加载**：需要正确加载 `.env.local` 文件才能读取 `DATABASE_URL`

---

## Supabase 安全配置

### ⚠️ 重要安全问题：Unrestricted 表

#### 问题描述
在 Supabase Table Editor 中，所有表都显示 "Unrestricted" 标记，这意味着：

1. **RLS（Row Level Security）未启用**
   - 数据可以被公开访问
   - 任何人都可以通过 API 读取/修改数据
   - 这是严重的安全隐患

2. **显示的警告信息**
   ```
   Data is publicly accessible via API as RLS is disabled. Learn more.
   ```

#### 立即修复方案

##### 1. 启用 RLS（行级安全）
```sql
-- 为每个表启用 RLS
ALTER TABLE users ENABLE ROW LEVEL SECURITY;
ALTER TABLE credits ENABLE ROW LEVEL SECURITY;
ALTER TABLE orders ENABLE ROW LEVEL SECURITY;
ALTER TABLE subscriptions ENABLE ROW LEVEL SECURITY;
ALTER TABLE subscription_plans ENABLE ROW LEVEL SECURITY;
ALTER TABLE subscription_usage ENABLE ROW LEVEL SECURITY;
```

##### 2. 创建访问策略
```sql
-- 用户只能查看自己的数据
CREATE POLICY "Users can view own data" ON users
  FOR SELECT USING (auth.uid()::text = user_uuid);

-- 用户只能查看自己的积分
CREATE POLICY "Users can view own credits" ON credits
  FOR SELECT USING (auth.uid()::text = user_uuid);

-- 用户只能查看自己的订阅
CREATE POLICY "Users can view own subscription" ON subscriptions
  FOR SELECT USING (auth.uid()::text = user_uuid);

-- 订阅计划所有人可查看（公开信息）
CREATE POLICY "Anyone can view subscription plans" ON subscription_plans
  FOR SELECT USING (true);
```

##### 3. 服务端访问（绕过 RLS）
```javascript
// 使用 service_role key（仅在服务端）
import { createClient } from '@supabase/supabase-js'

const supabase = createClient(
  process.env.SUPABASE_URL,
  process.env.SUPABASE_SERVICE_ROLE_KEY // 不是 anon key
)
```

---

## 常见问题与解决方案

### 问题 1：DATABASE_URL 未配置
**症状**：运行脚本时报错 "DATABASE_URL 未配置"

**解决方案**：
```javascript
// 确保加载 .env.local
require('dotenv').config();
require('dotenv').config({ path: '.env.local' });
```

### 问题 2：迁移文件未生成
**症状**：修改 schema 后运行 `db:generate` 没有生成新文件

**原因**：Drizzle 认为没有实质性改变

**解决方案**：
1. 检查 schema 文件语法
2. 确保有实际的表结构变化
3. 必要时手动创建迁移文件

### 问题 3：迁移执行失败
**症状**：`db:migrate` 报错

**可能原因**：
- 数据库连接问题
- 表已存在
- 外键约束冲突

**解决方案**：
1. 检查数据库连接
2. 查看 Supabase 日志
3. 必要时手动执行 SQL

---

## 最佳实践

### 1. 数据库架构设计
- **使用事务**：确保数据一致性
- **添加索引**：优化查询性能
- **设置默认值**：避免空值问题

### 2. 安全配置
- **始终启用 RLS**：防止数据泄露
- **最小权限原则**：只授予必要的权限
- **定期审查策略**：确保安全策略有效

### 3. 迁移管理
- **版本控制**：将迁移文件纳入 Git
- **测试环境先行**：先在开发环境测试
- **备份重要数据**：执行迁移前备份

### 4. 环境变量管理
```bash
# .env.local (开发环境)
DATABASE_URL="postgresql://..."
SUPABASE_URL="https://xxx.supabase.co"
SUPABASE_ANON_KEY="xxx"  # 客户端使用
SUPABASE_SERVICE_ROLE_KEY="xxx"  # 服务端使用（绕过 RLS）
```

### 5. 监控与日志
- 使用 Supabase Dashboard 监控查询
- 记录关键操作日志
- 设置错误告警

---

## 订阅系统集成总结

### 已完成工作
1. ✅ 设计三表结构（subscriptions、subscription_plans、subscription_usage）
2. ✅ 创建服务层（`src/services/subscription.ts`）
3. ✅ 更新 API 路由支持混合计费
4. ✅ 生成并执行数据库迁移
5. ✅ 验证表创建成功

### 待完成工作
1. ⚠️ **启用 RLS 保护数据安全**（紧急）
2. 📝 插入默认订阅计划数据
3. 💳 集成 Stripe 支付
4. 🎨 创建订阅管理界面
5. 📊 添加使用量分析

### 系统架构
```
用户请求 → API 路由 → 权限检查
                ↓
         [订阅用户？]
         ↙        ↘
      是            否
       ↓            ↓
  记录使用量    检查积分
       ↓            ↓
   不扣积分      扣除积分
       ↘          ↙
         AI 生成
```

---

## 紧急行动项

### 🔴 立即执行：启用 RLS

1. 登录 Supabase SQL Editor
2. 执行以下 SQL：

```sql
-- 批量启用 RLS
DO $$ 
DECLARE 
  r RECORD;
BEGIN
  FOR r IN SELECT tablename FROM pg_tables 
  WHERE schemaname = 'public' 
  LOOP
    EXECUTE 'ALTER TABLE ' || quote_ident(r.tablename) || ' ENABLE ROW LEVEL SECURITY;';
  END LOOP;
END $$;

-- 创建基本策略
-- 用户相关表：只能访问自己的数据
CREATE POLICY "Own data only" ON users FOR ALL USING (auth.uid()::text = user_uuid);
CREATE POLICY "Own data only" ON credits FOR ALL USING (auth.uid()::text = user_uuid);
CREATE POLICY "Own data only" ON orders FOR ALL USING (auth.uid()::text = user_email);
CREATE POLICY "Own data only" ON subscriptions FOR ALL USING (auth.uid()::text = user_uuid);
CREATE POLICY "Own data only" ON subscription_usage FOR ALL USING (auth.uid()::text = user_uuid);

-- 公开表：所有人可读
CREATE POLICY "Public read" ON subscription_plans FOR SELECT USING (true);
CREATE POLICY "Public read" ON posts FOR SELECT USING (status = 'online');
```

### 验证 RLS 状态
执行后，Table Editor 中的 "Unrestricted" 标记应该消失，变为带锁的图标。

---

## 参考资源

- [Supabase RLS 文档](https://supabase.com/docs/guides/auth/row-level-security)
- [Drizzle ORM 迁移指南](https://orm.drizzle.team/docs/migrations)
- [ShipAny 数据库文档](https://docs.shipany.ai/zh/features/database)

---

*最后更新：2025-01-15*
*作者：Claude Assistant*